<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Broadcast Admin</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <!-- firebase init-->
    <script src="broadcast.js"></script>
    <div class="pageTitle">
        <h1>Broadcast admin</h1>
        <p>Upload an audio file and it will broadcast to the whole danche24 website</p>
    </div>
    <div class="dropzone" id="dropzone">
        Drop file here <i>or</i> <label><input type="file" multiple="false" hidden accept="audio/*"/> <span class="uploadFile">click to upload file</span></label>
    </div>
    <div id="step2Info">
        Please review your audio file<br>
        <div id="title"></div><br>
        <input type="button" id="playAudio" onclick="playSound()" value="play audio"> 
        <input type="button" id="submit" onclick="submit()" value="submit" disabled> 
        <input type="button" id="clear" value="cancel">
    </div>
    <audio src="" id="broadcastObj" hidden></audio>
    <textarea id="mp3String" cols="100" rows="10" hidden></textarea>
    
    <script>
        importScripts("https://www.gstatic.com/firebasejs/7.22.0/firebase-app.js")
        importScripts("https://www.gstatic.com/firebasejs/7.22.0/firebase-analytics.js")
        var firebaseConfig = {apiKey: "AIzaSyAcrcquKzNjKh1PByVK4NglsVlnYXyeDJU",authDomain: "application-service-a1b32.firebaseapp.com",databaseURL: "https://application-service-a1b32.firebaseio.com",projectId: "application-service-a1b32",storageBucket: "application-service-a1b32.appspot.com",messagingSenderId: "164827554782",appId: "1:164827554782:web:b4b1a42c1d8acc753d334f",measurementId: "G-80953CEHTZ"};firebase.initializeApp(firebaseConfig);firebase.analytics();
        var dropzone = document.getElementById("dropzone")
        var dbChild = firebase.database().ref().child('broadcast')
        //drag over
        dropzone.ondragover = function(){
            this.className = "dropzone over"
            return false
        }
        dropzone.ondragleave = function(){
            this.className = "dropzone"
            return false
        }
        //when drop file
        dropzone.ondrop = function(e){
            e.preventDefault();
            this.className = "dropzone"
            if (e.dataTransfer.files.length > 1){
                dropzone.className = "dropzone error"
                dropzone.innerText = "Only one file is allowed"
                setTimeout(function(){
                    dropzone.className = "dropzone"
                    dropzone.innerHTML = "Drop file here <i>or</i> <label><input type=\"file\" multiple=\"false\" hidden accept=\"audio/*\"/> <span class=\"uploadFile\">click to upload file</span></label>"
                }, 3000)
            } else if (!e.dataTransfer.files[0].type.includes("audio")){
                dropzone.className = "dropzone error"
                dropzone.innerText = "Only audio file is accepted"
                setTimeout(function(){
                    dropzone.className = "dropzone"
                    dropzone.innerHTML = "Drop file here <i>or</i> <label><input type=\"file\" multiple=\"false\" hidden accept=\"audio/*\"/> <span class=\"uploadFile\">click to upload file</span></label>"
                }, 3000)
            } else {
                var file = e.dataTransfer.files[0]
                var name = e.dataTransfer.files[0].name
                dropzone.className = "dropzone success"
                dropzone.innerText = "Successfully upload file"
                setTimeout(function(){
                    dropzone.className = "dropzone hidden"
                    document.getElementById("step2Info").style.visibility = "visible"
                    document.getElementById("title").innerText = name
                    readFile(file)
                    dropzone.innerHTML = "Drop file here <i>or</i> <label><input type=\"file\" multiple=\"false\" hidden accept=\"audio/*\"/> <span class=\"uploadFile\">click to upload file</span></label>"
                }, 2000)
            }
        }
        //clear button function
        document.getElementById("clear").onclick = function(){
            document.getElementById("step2Info").style.visibility = "hidden"
            dropzone.className = "dropzone"
            dropzone.innerHTML = "Drop file here <i>or</i> <label><input type=\"file\" multiple=\"false\" hidden accept=\"audio/*\"/> <span class=\"uploadFile\">click to upload file</span></label>"
        }

        //click input
        document.querySelector('input[type="file"]').oninput = function (e) {
            dropzone.className = "dropzone success"
            dropzone.innerText = "Successfully upload file"
            setTimeout(function(){
                dropzone.className = "dropzone hidden"
                document.getElementById("step2Info").style.visibility = "visible"
            }, 2000)
        }



var context = new AudioContext();
var source = null;
var audioBuffer = null;
var Previewed = false

// Converts an ArrayBuffer to base64, by converting to string 
// and then using window.btoa' to base64. 

var bufferToBase64 = function (buffer) {
    var bytes = new Uint8Array(buffer);
    var len = buffer.byteLength;
    var binary = "";
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
    }
    return window.btoa(binary);
};

var base64ToBuffer = function (buffer) {
    var binary = window.atob(buffer);
    var buffer = new ArrayBuffer(binary.length);
    var bytes = new Uint8Array(buffer);
    for (var i = 0; i < buffer.byteLength; i++) {
        bytes[i] = binary.charCodeAt(i) & 0xFF;
    }
    return buffer;
};

function playSound() {
    document.getElementById("submit").disabled = false
    // source is global so we can call .stop() later.
    source = context.createBufferSource();
    source.buffer = audioBuffer;
    source.loop = false;
    source.connect(context.destination);
    source.start(0); // Play immediately.
}


function initSound(arrayBuffer) {
    var base64String = bufferToBase64(arrayBuffer);
    var audioFromString = base64ToBuffer(base64String);
    document.getElementById("mp3String").value=base64String;
    context.decodeAudioData(audioFromString, function (buffer) {
        // audioBuffer is global to reuse the decoded audio later.
        audioBuffer = buffer;
    }, function (e) {
        console.log('Error decoding file', e);
    });
}

// User selects file, read it as an ArrayBuffer and pass to the API.
var fileInput = document.querySelector('input[type="file"]');
fileInput.addEventListener('change', function (e) {
    var reader = new FileReader();
    reader.onload = function (e) {
        initSound(this.result);
    };
    reader.readAsArrayBuffer(this.files[0]);
    document.getElementById('title').innerText = this.files[0].name
    document.getElementById("submit").disabled = true
}, false);
function readFile (e) {
    var reader = new FileReader();
    reader.onload = function (e) {
        initSound(this.result);
    };
    reader.readAsArrayBuffer(e);
}

// Load file from a URL as an ArrayBuffer.
// Example: loading via xhr2: loadSoundFile('sounds/test.mp3');

function loadSoundFile(url) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function (e) {
        initSound(this.response); // this.response is an ArrayBuffer.
    };
    xhr.send();
}
function submit(){
    if(!confirm('You are sure the audio file have been reviewed and is appropriate to all user')){
        document.getElementById('clear').click()
        return
    }
    dbChild.set(document.getElementById('mp3String').value)
    setInterval(function(){
        dbChild.set('')
        document.getElementById('clear').click()
    }, 3000)
}
        
    </script>
</body>
</html>